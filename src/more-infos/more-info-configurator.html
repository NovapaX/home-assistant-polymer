<link rel='import' href='../../bower_components/polymer/polymer-element.html'>
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel='import' href='../../bower_components/iron-input/iron-input.html'>
<link rel='import' href='../../bower_components/paper-spinner/paper-spinner.html'>
<link rel='import' href='../../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../../bower_components/paper-input/paper-input.html'>

<dom-module id='more-info-configurator'>
  <template>
    <style is="custom-style" include="iron-flex"></style>
    <style>
      p {
        margin: 8px 0;
      }

      p > img {
        max-width: 100%;
      }

      p.center {
        text-align: center;
      }

      p.error {
        color: #C62828;
      }

      p.submit {
        text-align: center;
        height: 41px;
      }

      paper-spinner {
        width: 14px;
        height: 14px;
        margin-right: 20px;
      }

      [hidden] {
        display: none;
      }
    </style>

    <div class='layout vertical'>
      <template is='dom-if' if='[[isConfigurable]]'>

        <p hidden$='[[!stateObj.attributes.description]]'>
          [[stateObj.attributes.description]]
          <p hidden$='[[!stateObj.attributes.link_url]]'>
            <a
              href='[[stateObj.attributes.link_url]]'
              target='_blank'
            >
              [[stateObj.attributes.link_name]]
            </a>
          </p>
        </p>

        <p class='error' hidden$='[[!stateObj.attributes.errors]]'>
          [[stateObj.attributes.errors]]
        </p>

        <p class='center' hidden$='[[!stateObj.attributes.description_image]]'>
          <img src='[[stateObj.attributes.description_image]]' />
        </p>

        <template is='dom-repeat' items='[[stateObj.attributes.fields]]'>
          <paper-input
            label='[[item.name]]'
            name='[[item.id]]'
            type='[[item.type]]'
            value='[[getFieldInput(item.id)]]'
            on-change='fieldChanged'
          ></paper-input>
        </template>

        <p class='submit' hidden$='[[!stateObj.attributes.submit_caption]]'>
          <paper-button
            raised
            disabled='[[isConfiguring]]'
            on-tap='submitClicked'
          >
            <paper-spinner
              active='[[isConfiguring]]'
              hidden='[[!isConfiguring]]'
              alt='Configuring'></paper-spinner>
            [[stateObj.attributes.submit_caption]]
          </paper-button>

        </p>

      </template>
    </div>
  </template>
</dom-module>

<script>
class MoreInfoConfigurator extends Polymer.Element {
  static get is() { return 'more-info-configurator'; }

  static get properties() {
    return {
      stateObj: {
        type: Object,
      },

      configuratorId: {
        type: String,
        computed: 'computeConfiguratorId(stateObj)'
      },

      action: {
        type: String,
        value: 'display',
      },

      isConfigurable: {
        type: Boolean,
        computed: 'computeIsConfigurable(stateObj)',
      },

      isConfiguring: {
        type: Boolean,
        value: false,
      },

      fieldInput: {
        type: Object,
        value: function () { return {}; },
      },

      fieldInputDefaults: {
        type: Object,
        computed: 'computeFieldInputDefaults(stateObj)'
      },
    };
  }

  computeIsConfigurable(stateObj) {
    return stateObj.state === 'configure';
  }

  computeConfiguratorId(stateObj) {
    return stateObj.attributes.configure_id;
  }

  fieldChanged(ev) {
    var el = ev.target;
    this.setFieldInput(el.name, el.value);
  }

  computeFieldInputDefaults(stateObj) {
    this.ensureFieldInputForThisConfigurator();
    var values = {};
    stateObj.attributes.fields.forEach(function (field) {
      // skip if no default value given
      if (typeof field.default === 'undefined') {
        return;
      }
      // set default if no value is present.
      if (typeof this.getFieldInput(field.id) === 'undefined') {
        this.setFieldInput(field.id, field.default);
      }
      values[field.id] = field.default;
    }, this);
    return values;
  }

  getFieldInput(id) {
    return this.fieldInput[this.configuratorId][id];
  }

  setFieldInput(id, value) {
    this.fieldInput[this.configuratorId][id] = value;
  }

  ensureFieldInputForThisConfigurator() {
    if (!(this.configuratorId in this.fieldInput)) {
      this.fieldInput[this.configuratorId] = {};
    }
  }

  submitClicked() {
    var data = {
      configure_id: this.configuratorId,
      fields: this.fieldInput[this.configuratorId],
    };

    this.isConfiguring = true;

    this.hass.callService('configurator', 'configure', data).then(
      function () {
        this.isConfiguring = false;
      }.bind(this),
      function () {
        this.isConfiguring = false;
      }.bind(this)
    );
  }
}

customElements.define(MoreInfoConfigurator.is, MoreInfoConfigurator);
</script>
